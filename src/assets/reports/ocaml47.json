{"filename":"src/app/transaction_fuzzer/transaction_fuzzer.ml","lines":[{"line":"open Core","counters":[]},{"line":"open Mina_base","counters":[]},{"line":"open Mina_transaction","counters":[]},{"line":"module Rust = Mina_tree.Rust","counters":[]},{"line":"module Fp = Kimchi_pasta.Basic.Fp","counters":[]},{"line":"module Ledger = Mina_ledger.Ledger","counters":[]},{"line":"module Length = Mina_numbers.Length","counters":[]},{"line":"module Global_slot = Mina_numbers.Global_slot","counters":[]},{"line":"","counters":[]},{"line":"","counters":[]},{"line":"","counters":[]},{"line":"","counters":[]},{"line":"","counters":[]},{"line":"let txn_state_view: Zkapp_precondition.Protocol_state.View.t = {","counters":[]},{"line":"  snarked_ledger_hash = Fp.of_string(\"19095410909873291354237217869735884756874834695933531743203428046904386166496\")","counters":[{"col_start":35,"col_end":35,"count":1}]},{"line":"  ; timestamp = Block_time.of_int64(1600251300000L)","counters":[{"col_start":34,"col_end":34,"count":1}]},{"line":"  ; blockchain_length = Length.of_int(1)","counters":[{"col_start":36,"col_end":36,"count":1}]},{"line":"  ; last_vrf_output = ()","counters":[]},{"line":"  ; min_window_density = Length.of_int(77)","counters":[{"col_start":37,"col_end":37,"count":1}]},{"line":"  ; total_currency = Currency.Amount.of_int(10016100000000000)","counters":[{"col_start":42,"col_end":42,"count":1}]},{"line":"  ; global_slot_since_hard_fork = Global_slot.of_int(0)","counters":[{"col_start":51,"col_end":51,"count":1}]},{"line":"  ; global_slot_since_genesis = Global_slot.of_int(0)","counters":[{"col_start":49,"col_end":49,"count":1}]},{"line":"  ; staking_epoch_data = {","counters":[]},{"line":"    ledger = {","counters":[]},{"line":"        hash = Fp.of_string(\"19095410909873291354237217869735884756874834695933531743203428046904386166496\")","counters":[{"col_start":26,"col_end":26,"count":1}]},{"line":"        ; total_currency = Currency.Amount.of_int(10016100000000000)","counters":[{"col_start":48,"col_end":48,"count":1}]},{"line":"    }","counters":[]},{"line":"    ; seed = Mina_base.Epoch_seed.of_decimal_string(\"0\")","counters":[{"col_start":50,"col_end":50,"count":1}]},{"line":"    ; start_checkpoint = State_hash.zero","counters":[]},{"line":"    ; lock_checkpoint = State_hash.zero","counters":[]},{"line":"    ; epoch_length = Length.of_int(1)","counters":[{"col_start":33,"col_end":33,"count":1}]},{"line":"    }","counters":[]},{"line":"  ; next_epoch_data = {","counters":[]},{"line":"    ledger = {","counters":[]},{"line":"        hash = Fp.of_string(\"19095410909873291354237217869735884756874834695933531743203428046904386166496\")","counters":[{"col_start":26,"col_end":26,"count":1}]},{"line":"        ; total_currency = Currency.Amount.of_int(10016100000000000)","counters":[{"col_start":48,"col_end":48,"count":1}]},{"line":"    }","counters":[]},{"line":"    ; seed = Fp.of_string(\"18512313064034685696641580142878809378857342939026666126913761777372978255172\")","counters":[{"col_start":24,"col_end":24,"count":1}]},{"line":"    ; start_checkpoint = State_hash.zero","counters":[]},{"line":"    ; lock_checkpoint = Fp.of_string(\"9196091926153144288494889289330016873963015481670968646275122329689722912273\")","counters":[{"col_start":35,"col_end":35,"count":1}]},{"line":"    ; epoch_length = Length.of_int(2)","counters":[{"col_start":33,"col_end":33,"count":1}]},{"line":"    }","counters":[]},{"line":"  }","counters":[]},{"line":"","counters":[]},{"line":"","counters":[]},{"line":"let constraint_constants: (Genesis_constants.Constraint_constants.t option) ref = ref None","counters":[]},{"line":"","counters":[]},{"line":"let deserialize_constants constants_bytes =","counters":[]},{"line":"  Bin_prot.Reader.of_bytes [%bin_reader: Genesis_constants.Constraint_constants.t] constants_bytes","counters":[{"col_start":2,"col_end":2,"count":1}]},{"line":"","counters":[]},{"line":"","counters":[]},{"line":"let set_constraint_constants constants_bytes = constraint_constants := Some (deserialize_constants constants_bytes)","counters":[{"col_start":47,"col_end":47,"count":1},{"col_start":97,"col_end":97,"count":1}]},{"line":"","counters":[]},{"line":"","counters":[]},{"line":"let create_initial_accounts accounts =","counters":[]},{"line":"  let constraint_constants = match !constraint_constants with","counters":[{"col_start":2,"col_end":2,"count":2}]},{"line":"  | Some(constraint_constants) -> constraint_constants","counters":[{"col_start":4,"col_end":4,"count":2}]},{"line":"  | None -> failwith \"constraint_constants not initialized\"","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"  in","counters":[]},{"line":"  let packed =","counters":[]},{"line":"    Genesis_ledger_helper.Ledger.packed_genesis_ledger_of_accounts","counters":[]},{"line":"      ~depth:constraint_constants.ledger_depth (lazy (List.map ~f:(fun a -> (None, a)) accounts))","counters":[{"col_start":53,"col_end":53,"count":2},{"col_start":76,"col_end":76,"count":20}]},{"line":"  in","counters":[]},{"line":"  Lazy.force (Genesis_ledger.Packed.t packed)","counters":[{"col_start":2,"col_end":2,"count":2},{"col_start":36,"col_end":36,"count":2}]},{"line":"","counters":[]},{"line":"let deserialize_accounts accounts_bytes =","counters":[]},{"line":"  Bin_prot.Reader.of_bytes [%bin_reader: Account.Stable.Latest.t list] accounts_bytes","counters":[{"col_start":2,"col_end":2,"count":2}]},{"line":"","counters":[]},{"line":"let ledger: (Ledger.t option) ref = ref None","counters":[]},{"line":"","counters":[]},{"line":"let set_initial_accounts accounts_bytes =","counters":[]},{"line":"  let ledger_ = create_initial_accounts (deserialize_accounts accounts_bytes) in","counters":[{"col_start":2,"col_end":2,"count":2},{"col_start":60,"col_end":60,"count":2}]},{"line":"    ledger := Some ledger_;","counters":[{"col_start":4,"col_end":4,"count":2}]},{"line":"    let ledger_hash = Ledger.merkle_root ledger_ in","counters":[]},{"line":"    Bin_prot.Writer.to_bytes [%bin_writer: Fp.t] ledger_hash","counters":[{"col_start":4,"col_end":4,"count":2}]},{"line":"","counters":[]},{"line":"let apply_tx user_command_bytes =","counters":[]},{"line":"  try","counters":[{"col_start":2,"col_end":2,"count":0}]},{"line":"    let command = Bin_prot.Reader.of_bytes [%bin_reader: User_command.Stable.Latest.t] user_command_bytes in","counters":[]},{"line":"    (*Core_kernel.printf !\"%{sexp:User_command.t}\\n%!\" command;*)","counters":[]},{"line":"    let tx = Transaction.Command command in","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"    let constraint_constants = match !constraint_constants with","counters":[]},{"line":"      | Some(constraint_constants) -> constraint_constants","counters":[{"col_start":8,"col_end":8,"count":0}]},{"line":"      | None -> failwith \"constraint_constants not initialized\"","counters":[{"col_start":8,"col_end":8,"count":0}]},{"line":"    in","counters":[]},{"line":"    let ledger = match !ledger with","counters":[]},{"line":"      | Some(ledger) -> ledger","counters":[{"col_start":8,"col_end":8,"count":0}]},{"line":"      | None -> failwith \"ledger not initialized\"","counters":[{"col_start":8,"col_end":8,"count":0}]},{"line":"    in","counters":[]},{"line":"    let _applied = Ledger.apply_transaction ~constraint_constants ~txn_state_view ledger tx in","counters":[]},{"line":"    (*Core_kernel.printf !\"%{sexp:Ledger.Transaction_applied.t Or_error.t}\\n%!\" applied;*)","counters":[]},{"line":"    let ledger_hash = Ledger.merkle_root ledger in","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"    Bin_prot.Writer.to_bytes [%bin_writer: Fp.t] ledger_hash","counters":[{"col_start":4,"col_end":4,"count":0},{"col_start":27,"col_end":27,"count":0}]},{"line":"  with","counters":[]},{"line":"    e -> let msg = Exn.to_string e in","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"    let bt = Printexc.get_backtrace () in","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"    Core_kernel.printf !\"except: %s\\n%s\\n%!\" msg bt;","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"    raise e","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"","counters":[]},{"line":"let get_coverage _ =","counters":[]},{"line":"  List.map (Bisect.Runtime.get_coverage_flattened ()) ~f:(","counters":[{"col_start":2,"col_end":2,"count":1},{"col_start":48,"col_end":48,"count":1}]},{"line":"    fun {filename; points; counts} -> (","counters":[{"col_start":38,"col_end":38,"count":48}]},{"line":"      filename,","counters":[]},{"line":"      Array.fold_right points ~f:(fun x acc -> (Int64.of_int x) :: acc) ~init:[],","counters":[{"col_start":21,"col_end":21,"count":47},{"col_start":47,"col_end":47,"count":3909},{"col_start":59,"col_end":59,"count":3909}]},{"line":"      Array.fold_right counts ~f:(fun x acc -> (Int64.of_int x) :: acc) ~init:[]","counters":[{"col_start":21,"col_end":21,"count":47},{"col_start":47,"col_end":47,"count":3926},{"col_start":59,"col_end":59,"count":3927}]},{"line":"    )","counters":[]},{"line":"  )","counters":[]},{"line":"","counters":[]},{"line":"let run_command =","counters":[]},{"line":"  Command.basic","counters":[{"col_start":14,"col_end":14,"count":1}]},{"line":"    ~summary:\"Run the fuzzer\"","counters":[]},{"line":"    Command.Param.(map","counters":[{"col_start":21,"col_end":21,"count":1}]},{"line":"      (anon (\"seed\" %: int))","counters":[{"col_start":10,"col_end":10,"count":1},{"col_start":21,"col_end":21,"count":1}]},{"line":"      ~f:(fun seed ->","counters":[]},{"line":"        fun () -> Rust.transaction_fuzzer (Int64.of_int seed) set_constraint_constants set_initial_accounts apply_tx get_coverage","counters":[{"col_start":18,"col_end":18,"count":1},{"col_start":54,"col_end":54,"count":1}]},{"line":"        ))","counters":[]},{"line":"","counters":[]},{"line":"let reproduce_command =","counters":[]},{"line":"  Command.basic","counters":[{"col_start":14,"col_end":14,"count":1}]},{"line":"    ~summary:\"Reproduce fuzzcase\"","counters":[]},{"line":"    Command.Param.(map","counters":[{"col_start":21,"col_end":21,"count":1}]},{"line":"      (anon (\"fuzzcase\" %: string))","counters":[{"col_start":10,"col_end":10,"count":1},{"col_start":25,"col_end":25,"count":1}]},{"line":"      ~f:(fun fuzzcase ->","counters":[]},{"line":"        fun () -> Rust.transaction_fuzzer_reproduce set_constraint_constants set_initial_accounts apply_tx (Bytes.of_string fuzzcase)","counters":[{"col_start":18,"col_end":18,"count":0},{"col_start":122,"col_end":122,"count":0}]},{"line":"        ))","counters":[]},{"line":"","counters":[]},{"line":"let () =","counters":[]},{"line":"  Command.run","counters":[{"col_start":12,"col_end":12,"count":0}]},{"line":"    (Command.group ~summary:\"transaction_fuzzer\"","counters":[{"col_start":17,"col_end":17,"count":1}]},{"line":"      [ \"run\", run_command;","counters":[]}]}