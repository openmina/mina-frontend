{"filename":"src/lib/transition_frontier/extensions/extensions.ml","lines":[{"line":"open Async_kernel","counters":[]},{"line":"open Core_kernel","counters":[]},{"line":"open Pipe_lib","counters":[]},{"line":"module Best_tip_diff = Best_tip_diff","counters":[]},{"line":"module Identity = Identity","counters":[]},{"line":"module Root_history = Root_history","counters":[]},{"line":"module Snark_pool_refcount = Snark_pool_refcount","counters":[]},{"line":"module Transition_registry = Transition_registry","counters":[]},{"line":"module New_breadcrumbs = New_breadcrumbs","counters":[]},{"line":"module Ledger_table = Ledger_table","counters":[]},{"line":"","counters":[]},{"line":"type t =","counters":[{"col_start":0,"col_end":0,"count":0},{"col_start":5,"col_end":5,"count":0}]},{"line":"  { root_history : Root_history.Broadcasted.t","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"  ; snark_pool_refcount : Snark_pool_refcount.Broadcasted.t","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"  ; best_tip_diff : Best_tip_diff.Broadcasted.t","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"  ; transition_registry : Transition_registry.Broadcasted.t","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"  ; ledger_table : Ledger_table.Broadcasted.t","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"  ; identity : Identity.Broadcasted.t","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"  ; new_breadcrumbs : New_breadcrumbs.Broadcasted.t","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"  }","counters":[]},{"line":"[@@deriving fields]","counters":[]},{"line":"","counters":[]},{"line":"let create ~logger frontier : t Deferred.t =","counters":[]},{"line":"  let open Deferred.Let_syntax in","counters":[{"col_start":2,"col_end":2,"count":0}]},{"line":"  let%bind root_history =","counters":[]},{"line":"    Root_history.(Broadcasted.create (create ~logger frontier))","counters":[{"col_start":35,"col_end":35,"count":0},{"col_start":43,"col_end":43,"count":0}]},{"line":"  in","counters":[]},{"line":"  let%bind snark_pool_refcount =","counters":[]},{"line":"    Snark_pool_refcount.(Broadcasted.create (create ~logger frontier))","counters":[{"col_start":42,"col_end":42,"count":0},{"col_start":50,"col_end":50,"count":0}]},{"line":"  in","counters":[]},{"line":"  let%bind best_tip_diff =","counters":[]},{"line":"    Best_tip_diff.(Broadcasted.create (create ~logger frontier))","counters":[{"col_start":36,"col_end":36,"count":0},{"col_start":44,"col_end":44,"count":0}]},{"line":"  in","counters":[]},{"line":"  let%bind transition_registry =","counters":[]},{"line":"    Transition_registry.(Broadcasted.create (create ~logger frontier))","counters":[{"col_start":42,"col_end":42,"count":0},{"col_start":50,"col_end":50,"count":0}]},{"line":"  in","counters":[]},{"line":"  let%bind identity = Identity.(Broadcasted.create (create ~logger frontier)) in","counters":[{"col_start":49,"col_end":49,"count":0},{"col_start":57,"col_end":57,"count":0}]},{"line":"  let%bind new_breadcrumbs =","counters":[]},{"line":"    New_breadcrumbs.(Broadcasted.create (create ~logger frontier))","counters":[{"col_start":38,"col_end":38,"count":0},{"col_start":46,"col_end":46,"count":0}]},{"line":"  in","counters":[]},{"line":"  let%bind ledger_table =","counters":[]},{"line":"    Ledger_table.(Broadcasted.create (create ~logger frontier))","counters":[{"col_start":35,"col_end":35,"count":0},{"col_start":43,"col_end":43,"count":0}]},{"line":"  in","counters":[]},{"line":"  return","counters":[{"col_start":2,"col_end":2,"count":0}]},{"line":"    { root_history","counters":[]},{"line":"    ; snark_pool_refcount","counters":[]},{"line":"    ; best_tip_diff","counters":[]},{"line":"    ; transition_registry","counters":[]},{"line":"    ; identity","counters":[]},{"line":"    ; ledger_table","counters":[]},{"line":"    ; new_breadcrumbs","counters":[]},{"line":"    }","counters":[]},{"line":"","counters":[]},{"line":"(* HACK: A way to ensure that all the pipes are closed in a type-safe manner *)","counters":[]},{"line":"let close t : unit =","counters":[]},{"line":"  let close_extension (type t)","counters":[{"col_start":2,"col_end":2,"count":0}]},{"line":"      (module B : Intf.Broadcasted_extension_intf with type t = t) field =","counters":[]},{"line":"    B.close (Field.get field t)","counters":[{"col_start":4,"col_end":4,"count":0},{"col_start":21,"col_end":21,"count":0}]},{"line":"  in","counters":[]},{"line":"  Fields.iter","counters":[]},{"line":"    ~root_history:(close_extension (module Root_history.Broadcasted))","counters":[{"col_start":33,"col_end":33,"count":0}]},{"line":"    ~snark_pool_refcount:","counters":[]},{"line":"      (close_extension (module Snark_pool_refcount.Broadcasted))","counters":[{"col_start":21,"col_end":21,"count":0}]},{"line":"    ~best_tip_diff:(close_extension (module Best_tip_diff.Broadcasted))","counters":[{"col_start":34,"col_end":34,"count":0}]},{"line":"    ~transition_registry:","counters":[]},{"line":"      (close_extension (module Transition_registry.Broadcasted))","counters":[{"col_start":21,"col_end":21,"count":0}]},{"line":"    ~ledger_table:(close_extension (module Ledger_table.Broadcasted))","counters":[{"col_start":33,"col_end":33,"count":0}]},{"line":"    ~identity:(close_extension (module Identity.Broadcasted))","counters":[{"col_start":29,"col_end":29,"count":0}]},{"line":"    ~new_breadcrumbs:(close_extension (module New_breadcrumbs.Broadcasted))","counters":[{"col_start":36,"col_end":36,"count":0}]},{"line":"","counters":[]},{"line":"let notify (t : t) ~frontier ~diffs_with_mutants =","counters":[]},{"line":"  let update (type t)","counters":[{"col_start":2,"col_end":2,"count":0}]},{"line":"      (module B : Intf.Broadcasted_extension_intf with type t = t) field =","counters":[]},{"line":"    B.update (Field.get field t) frontier diffs_with_mutants","counters":[{"col_start":4,"col_end":4,"count":0},{"col_start":22,"col_end":22,"count":0}]},{"line":"  in","counters":[]},{"line":"  Deferred.List.all_unit","counters":[]},{"line":"    (Fields.to_list","counters":[]},{"line":"       ~root_history:(update (module Root_history.Broadcasted))","counters":[{"col_start":27,"col_end":27,"count":0}]},{"line":"       ~snark_pool_refcount:(update (module Snark_pool_refcount.Broadcasted))","counters":[{"col_start":34,"col_end":34,"count":0}]},{"line":"       ~best_tip_diff:(update (module Best_tip_diff.Broadcasted))","counters":[{"col_start":28,"col_end":28,"count":0}]},{"line":"       ~transition_registry:(update (module Transition_registry.Broadcasted))","counters":[{"col_start":34,"col_end":34,"count":0}]},{"line":"       ~ledger_table:(update (module Ledger_table.Broadcasted))","counters":[{"col_start":27,"col_end":27,"count":0}]},{"line":"       ~new_breadcrumbs:(update (module New_breadcrumbs.Broadcasted))","counters":[{"col_start":30,"col_end":30,"count":0}]},{"line":"       ~identity:(update (module Identity.Broadcasted)) )","counters":[{"col_start":23,"col_end":23,"count":0}]},{"line":"","counters":[]},{"line":"type ('ext, 'view) access =","counters":[]},{"line":"  | Root_history : (Root_history.t, Root_history.view) access","counters":[]},{"line":"  | Snark_pool_refcount","counters":[]},{"line":"      : (Snark_pool_refcount.t, Snark_pool_refcount.view) access","counters":[]},{"line":"  | Best_tip_diff : (Best_tip_diff.t, Best_tip_diff.view) access","counters":[]},{"line":"  | Transition_registry","counters":[]},{"line":"      : (Transition_registry.t, Transition_registry.view) access","counters":[]},{"line":"  | Ledger_table : (Ledger_table.t, Ledger_table.view) access","counters":[]},{"line":"  | Identity : (Identity.t, Identity.view) access","counters":[]},{"line":"  | New_breadcrumbs : (New_breadcrumbs.t, New_breadcrumbs.view) access","counters":[]},{"line":"","counters":[]},{"line":"type ('ext, 'view) broadcasted_extension =","counters":[]},{"line":"  | Broadcasted_extension :","counters":[]},{"line":"      (module Intf.Broadcasted_extension_intf","counters":[]},{"line":"         with type t = 't","counters":[]},{"line":"          and type extension = 'ext","counters":[]},{"line":"          and type view = 'view )","counters":[]},{"line":"      * 't","counters":[]},{"line":"      -> ('ext, 'view) broadcasted_extension","counters":[]},{"line":"","counters":[]},{"line":"let get :","counters":[]},{"line":"    type ext view. t -> (ext, view) access -> (ext, view) broadcasted_extension","counters":[]},{"line":"    =","counters":[]},{"line":" fun { root_history","counters":[]},{"line":"     ; snark_pool_refcount","counters":[]},{"line":"     ; best_tip_diff","counters":[]},{"line":"     ; transition_registry","counters":[]},{"line":"     ; ledger_table","counters":[]},{"line":"     ; new_breadcrumbs","counters":[]},{"line":"     ; identity","counters":[]},{"line":"     } -> function","counters":[]},{"line":"  | Root_history ->","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"      Broadcasted_extension ((module Root_history.Broadcasted), root_history)","counters":[]},{"line":"  | Snark_pool_refcount ->","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"      Broadcasted_extension","counters":[]},{"line":"        ((module Snark_pool_refcount.Broadcasted), snark_pool_refcount)","counters":[]},{"line":"  | Best_tip_diff ->","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"      Broadcasted_extension ((module Best_tip_diff.Broadcasted), best_tip_diff)","counters":[]},{"line":"  | Transition_registry ->","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"      Broadcasted_extension","counters":[]},{"line":"        ((module Transition_registry.Broadcasted), transition_registry)","counters":[]},{"line":"  | Ledger_table ->","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"      Broadcasted_extension ((module Ledger_table.Broadcasted), ledger_table)","counters":[]},{"line":"  | Identity ->","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"      Broadcasted_extension ((module Identity.Broadcasted), identity)","counters":[]},{"line":"  | New_breadcrumbs ->","counters":[{"col_start":4,"col_end":4,"count":0}]},{"line":"      Broadcasted_extension","counters":[]},{"line":"        ((module New_breadcrumbs.Broadcasted), new_breadcrumbs)","counters":[]},{"line":"","counters":[]},{"line":"let get_extension : type ext view. t -> (ext, view) access -> ext =","counters":[]},{"line":" fun t access ->","counters":[]},{"line":"  let (Broadcasted_extension ((module B), ext)) = get t access in","counters":[{"col_start":2,"col_end":2,"count":0}]},{"line":"  B.extension ext","counters":[{"col_start":2,"col_end":2,"count":0}]},{"line":"","counters":[]},{"line":"let get_view_pipe :","counters":[]},{"line":"    type ext view. t -> (ext, view) access -> view Broadcast_pipe.Reader.t =","counters":[]},{"line":" fun t access ->","counters":[]},{"line":"  let (Broadcasted_extension ((module B), ext)) = get t access in","counters":[{"col_start":2,"col_end":2,"count":0}]},{"line":"  B.reader ext","counters":[{"col_start":2,"col_end":2,"count":0},{"col_start":13,"col_end":13,"count":2}]}]}